# FEMA: Fast and efficient mixed-effects algorithm for large sample whole-brain imaging data 

Pravesh Parekh, Chun Chieh Fan, Oleksandr Frei, Clare E. Palmer, Diana M. Smith, Carolina Makowski, John R. Iversen, Diliana Pecheva, Dominic Holland, Robert Loughnan, Pierre Nedelec, Wesley K. Thompson, Donald J. Hagler Jr., Ole A. Andreassen, Terry L. Jernigan, Thomas E. Nichols, and Anders M. Dale 

**Preprint available [on bioRxiv](https://doi.org/10.1101/2021.10.27.466202)**

*This repository contains the code for performing the analyses and creating figures as reported in the FEMA methods paper*


## Requirements
* [MATLAB](http://mathworks.com)

* FEMA and associated tools/utility functions [Download the repository here](https://github.com/cmig-research-group/cmig_tools)

* For running the applications on the ACBD Study data, you will need access to the [Adolescent Brain Cognitive Development<sup>SM</sup> data](https://abcdstudy.org/)

## Table of Contentes
* Simulations
  - Simulation 1: effect of binning and parameter recovery
  - Simulation 2: comparison with `fitlme`
  - Simulation 3: comparison of computational time
  - Simulation 4: examining type I error rate
  - Simulation 5: parameter recovery as a function of number of observations
* Applications using the ABCD Study data
  - Application 1: cortical thickness
    - ROI-level analysis and comparison with `fitlmematrix`
    - vertex-wise analysis
  - Application 2: correlation matrix dervied from resting state functional MRI

## Simulation 1: effect of binning and parameter recovery
Run [sim001_doExp_effectBinning](/sim001_doExp_effectBinning.m) to run the experiment, followed by [sim001_summarize_effectBinning](/sim001_summarize_effectBinning.m) to summarize the results. The script [sim001_plotResults_effectBinning](/sim001_plotResults_effectBinning.m) produces Figure 1 from the main paper while [sim001_plotResults_parametersGTruth](/sim001_plotResults_parametersGTruth.m) produces multiple sub-figures which were then put together as Figure 2 in the main paper.

## Simulation 2: comparison with `fitlme`
Run [sim002_doExp_comparefitlme](/sim002_doExp_comparefitlme.m) to run the experiment, followed by [sim002_summarize_comparefitlme](/sim002_summarize_comparefitlme.m) to summarize the results. The script [sim002_plotResults_comparefitlme](/sim002_plotResults_comparefitlme.m) produce supplementary Figures S3 and S4.

## Simulation 3: comparison of computational time
Run [sim003_doExp_timingnObs](/sim003_doExp_timingnObs.m) to compare computational time between `FEMA` and `fitlmematrix` as a function of number of observations. Run [sim003_doExp_timingnYvars](/sim003_doExp_timingnYvars.m) to compare these computational time as a function of number of *y* variables. These are associated with their respective summarize functions [sim003_summarize_timingnObs](/sim003_summarize_timingnObs.m) and [sim003_summarize_timingnYvars](/sim003_summarize_timingnYvars.m). Calling script [sim003_plotResults_timingnObs_FS_SE_FSE](/sim003_plotResults_timingnObs_FS_SE_FSE.m) will generate Figure 3 from the main paper while [sim003_plotResults_timingnObs_AE_FAE_SAE_FASE](/sim003_plotResults_timingnObs_AE_FAE_SAE_FASE.m) will generate supplementary Figure S5. Script [sim003_plotResults_timingnYvars](/sim003_plotResults_timingnYvars.m) can be used to create Figure 4 from the main paper.

## Simulation 4: examining type I error rate
Run [sim004_doExp_typeI](/sim004_doExp_typeI.m) to examine the type I error rate between `FEMA` and `fitlmematrix`. These results can be summarized by calling [sim004_summarize_typeI](/sim004_summarize_typeI.m) and [sim004_summarize_typeI_additionalInfo](/sim004_summarize_typeI_additionalInfo.m) scripts, while supplementary Figure S6 can be generated by calling [sim004_plotResults_typeI](/sim004_plotResults_typeI.m).

## Simulation 5: parameter recovery as a function of number of observations
Run [sim005_doExp_paramRecovery_nObs](/sim005_doExp_paramRecovery_nObs.m) to run the experiment and [sim005_summarize_paramRecovery_nObs](/sim005_summarize_paramRecovery_nObs.m) to summarize the results. Calling script [sim005_plotResults_paramRecovery_nObs](/sim005_plotResults_paramRecovery_nObs.m) will create supplementary Figure S7.

## Prior to running applications
Run [abcd_makeDesignMatrix](/abcd_makeDesignMatrix.m) to create a design matrix that will be used for subsequent analyses.

## Application 1a: cortical thickness (ROI-level) and comparison with `fitlmematrix`
Run [abcd_CThick_analyze_ROIs](/abcd_CThick_analyze_ROIs.m) to run ROI-level cortical thickness analysis. The results can be summarized using [abcd_CThick_summarize_ROIs](/abcd_CThick_summarize_ROIs.m) and plotted with [abcd_CThick_plot_ROIs](/abcd_CThick_plot_ROIs.m) to create supplementary Figures S8, S9, and S10.

## Application 1b: cortical thickness (vertex-wise)
Run [abcd_CThick_analyze_vertexWise](/abcd_CThick_analyze_vertexWise.m) to run vertex-wise cortical thickness analyses. Use the script [abcd_CThick_plot_vertexWise](/abcd_CThick_plot_vertexWise.m) to visualize the results (Figure 5 from the main paper and supplementary Figure S11).

## Application 2: correlation matrix derived from resting state functional connectivity
Run [abcd_CorrMat_analyze](/abcd_CorrMat_analyze.m) to run the analysis and [abcd_CorrMat_plot](/abcd_CorrMat_plot.m) to visualize the results (Figure 6 from the main paper and supplementary Figure S12; note that the names of the atlases/parcellation schemes were added externally).
